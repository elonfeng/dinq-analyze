<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Usage Statistics</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #333;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 300px;
        }
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .stat-box {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
            flex: 1;
            margin: 0 5px;
        }
        .stat-box h3 {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        .stat-box p {
            margin: 10px 0 0;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filters select, .filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .filters button {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .filters button:hover {
            background: #45a049;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 16px;
            margin: 0 5px;
            background: #f2f2f2;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .pagination button.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        .pagination button:hover:not(.active) {
            background: #ddd;
        }
        .error {
            color: #f44336;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>API Usage Statistics</h1>

    <div id="error" class="error" style="display: none;"></div>

    <div class="container">
        <div class="card">
            <h2>Overview</h2>
            <div class="filters">
                <select id="days-select">
                    <option value="3" selected>Last 3 days</option>
                    <option value="7">Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30">Last 30 days</option>
                </select>
                <div>
                    <label><input type="checkbox" id="include-endpoints"> Include endpoints</label>
                    <label><input type="checkbox" id="include-recent"> Include recent calls</label>
                </div>
                <button id="refresh-stats">Refresh</button>
            </div>

            <div id="loading-stats" class="loading">Loading statistics...</div>

            <div id="stats-content" style="display: none;">
                <div class="stats">
                    <div class="stat-box">
                        <h3>Total API Calls</h3>
                        <p id="total-calls">0</p>
                    </div>
                    <div class="stat-box">
                        <h3>Unique Endpoints</h3>
                        <p id="unique-endpoints">0</p>
                    </div>
                    <div class="stat-box">
                        <h3>Average Daily Calls</h3>
                        <p id="avg-daily-calls">0</p>
                    </div>
                </div>

                <h3>Endpoints Usage</h3>
                <div class="chart-container">
                    <canvas id="endpoints-chart"></canvas>
                </div>

                <h3>Daily Usage</h3>
                <div class="chart-container">
                    <canvas id="daily-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Recent API Calls</h2>
            <div id="loading-recent" class="loading">Loading recent calls...</div>

            <div id="recent-content" style="display: none;">
                <table id="recent-calls-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Endpoint</th>
                            <th>Query</th>
                            <th>Status</th>
                            <th>Execution Time</th>
                        </tr>
                    </thead>
                    <tbody id="recent-calls-body">
                        <!-- Recent calls will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Detailed API Usage</h2>
            <div class="filters">
                <select id="endpoint-filter">
                    <option value="">All Endpoints</option>
                    <!-- Endpoints will be inserted here -->
                </select>
                <input type="date" id="start-date" placeholder="Start Date">
                <input type="date" id="end-date" placeholder="End Date">
                <button id="apply-filters">Apply Filters</button>
            </div>

            <div id="loading-details" class="loading">Loading details...</div>

            <div id="details-content" style="display: none;">
                <table id="details-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Endpoint</th>
                            <th>Query</th>
                            <th>Status</th>
                            <th>Execution Time</th>
                        </tr>
                    </thead>
                    <tbody id="details-body">
                        <!-- Details will be inserted here -->
                    </tbody>
                </table>

                <div class="pagination" id="pagination">
                    <!-- Pagination buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Configuration
        const API_BASE_URL = '/api';
        let userId = localStorage.getItem('userId') || '';

        // If no userId is stored, prompt the user
        if (!userId) {
            userId = prompt('Please enter your user ID:');
            if (userId) {
                localStorage.setItem('userId', userId);
            }
        }

        // Charts
        let endpointsChart = null;
        let dailyChart = null;

        // Current state
        let currentPage = 1;
        let totalPages = 1;
        let perPage = 20;
        let currentEndpoint = '';
        let currentStartDate = '';
        let currentEndDate = '';

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('refresh-stats').addEventListener('click', loadStats);
            document.getElementById('apply-filters').addEventListener('click', loadDetails);

            // Set default dates
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('start-date').valueAsDate = thirtyDaysAgo;
            document.getElementById('end-date').valueAsDate = today;

            // Load initial data
            loadStats();
            loadDetails();
        });

        // Load statistics
        function loadStats() {
            const days = document.getElementById('days-select').value;
            const includeEndpoints = document.getElementById('include-endpoints').checked;
            const includeRecent = document.getElementById('include-recent').checked;

            // Show loading
            document.getElementById('loading-stats').style.display = 'block';
            document.getElementById('stats-content').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            // Build query string
            let queryParams = `days=${days}`;
            if (includeEndpoints) queryParams += '&include_endpoints=true';
            if (includeRecent) queryParams += '&include_recent=true';

            // Make API request
            fetch(`${API_BASE_URL}/usage/stats?${queryParams}`, {
                headers: {
                    'Userid': userId
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }

                // Update statistics
                document.getElementById('total-calls').textContent = data.data.total_calls;

                // Calculate average daily calls
                const dailyData = data.data.daily_usage;
                let totalDailyCalls = 0;
                dailyData.forEach(day => totalDailyCalls += day.count);
                const avgDailyCalls = dailyData.length > 0 ? (totalDailyCalls / dailyData.length).toFixed(1) : 0;
                document.getElementById('avg-daily-calls').textContent = avgDailyCalls;

                // Update unique endpoints count
                if (data.data.endpoints) {
                    document.getElementById('unique-endpoints').textContent = data.data.endpoints.length;
                    // Update endpoints chart
                    updateEndpointsChart(data.data.endpoints);
                    // Update endpoint filter options
                    updateEndpointOptions(data.data.endpoints);
                } else {
                    document.getElementById('unique-endpoints').textContent = 'N/A';
                    // Clear endpoints chart
                    if (endpointsChart) {
                        endpointsChart.destroy();
                        endpointsChart = null;
                    }
                }

                // Update daily chart
                updateDailyChart(data.data.daily_usage);

                // Update recent calls if available
                if (data.data.recent_calls) {
                    updateRecentCalls(data.data.recent_calls);
                    document.getElementById('loading-recent').style.display = 'none';
                    document.getElementById('recent-content').style.display = 'block';
                } else {
                    document.getElementById('recent-calls-body').innerHTML = '<tr><td colspan="5" style="text-align: center;">Enable "Include recent calls" to see recent API calls</td></tr>';
                    document.getElementById('loading-recent').style.display = 'none';
                    document.getElementById('recent-content').style.display = 'block';
                }

                // Hide loading, show content
                document.getElementById('loading-stats').style.display = 'none';
                document.getElementById('stats-content').style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading stats:', error);
                document.getElementById('error').textContent = `Error: ${error.message}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading-stats').style.display = 'none';
            });
        }

        // Load detailed usage
        function loadDetails() {
            // Get filter values
            const endpoint = document.getElementById('endpoint-filter').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            // Update current state
            currentEndpoint = endpoint;
            currentStartDate = startDate;
            currentEndDate = endDate;
            currentPage = 1;
            perPage = 10; // Updated default per_page value

            // Show loading
            document.getElementById('loading-details').style.display = 'block';
            document.getElementById('details-content').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            // Build query string
            let queryParams = `page=${currentPage}&per_page=${perPage}`;
            if (endpoint) queryParams += `&endpoint=${encodeURIComponent(endpoint)}`;
            if (startDate) queryParams += `&start_date=${encodeURIComponent(startDate)}`;
            if (endDate) queryParams += `&end_date=${encodeURIComponent(endDate)}`;

            // Make API request
            fetch(`${API_BASE_URL}/usage/details?${queryParams}`, {
                headers: {
                    'Userid': userId
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }

                // Update details table
                updateDetailsTable(data.data.records);

                // Update pagination
                totalPages = data.data.pagination.total_pages;
                perPage = data.data.pagination.per_page; // Update perPage from response
                updatePagination();

                // Show date range info
                const startDateInfo = new Date(data.data.filters.start_date).toLocaleDateString();
                const endDateInfo = new Date(data.data.filters.end_date).toLocaleDateString();
                const dateRangeInfo = document.createElement('div');
                dateRangeInfo.style.marginTop = '10px';
                dateRangeInfo.style.fontSize = '14px';
                dateRangeInfo.style.color = '#666';
                dateRangeInfo.textContent = `Showing data from ${startDateInfo} to ${endDateInfo}`;

                // Check if date range was adjusted
                const requestedStartDate = startDate ? new Date(startDate).toISOString().split('T')[0] : null;
                const actualStartDate = data.data.filters.start_date ? new Date(data.data.filters.start_date).toISOString().split('T')[0] : null;

                if (requestedStartDate && actualStartDate && requestedStartDate !== actualStartDate) {
                    dateRangeInfo.textContent += ' (Date range adjusted to 30 days maximum)';
                    dateRangeInfo.style.color = '#f57c00';
                }

                // Add date range info to the page
                const paginationElement = document.getElementById('pagination');
                if (paginationElement.parentNode.querySelector('.date-range-info')) {
                    paginationElement.parentNode.removeChild(paginationElement.parentNode.querySelector('.date-range-info'));
                }
                dateRangeInfo.className = 'date-range-info';
                paginationElement.parentNode.insertBefore(dateRangeInfo, paginationElement);

                // Hide loading, show content
                document.getElementById('loading-details').style.display = 'none';
                document.getElementById('details-content').style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading details:', error);
                document.getElementById('error').textContent = `Error: ${error.message}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading-details').style.display = 'none';
            });
        }

        // Load specific page of details
        function loadPage(page) {
            currentPage = page;

            // Show loading
            document.getElementById('loading-details').style.display = 'block';
            document.getElementById('details-content').style.display = 'none';

            // Build query string
            let queryParams = `page=${currentPage}&per_page=${perPage}`;
            if (currentEndpoint) queryParams += `&endpoint=${encodeURIComponent(currentEndpoint)}`;
            if (currentStartDate) queryParams += `&start_date=${encodeURIComponent(currentStartDate)}`;
            if (currentEndDate) queryParams += `&end_date=${encodeURIComponent(currentEndDate)}`;

            // Make API request
            fetch(`${API_BASE_URL}/usage/details?${queryParams}`, {
                headers: {
                    'Userid': userId
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }

                // Update details table
                updateDetailsTable(data.data.records);

                // Update pagination
                totalPages = data.data.pagination.total_pages;
                updatePagination();

                // Hide loading, show content
                document.getElementById('loading-details').style.display = 'none';
                document.getElementById('details-content').style.display = 'block';
            })
            .catch(error => {
                console.error('Error loading page:', error);
                document.getElementById('error').textContent = `Error: ${error.message}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading-details').style.display = 'none';
            });
        }

        // Update endpoints chart
        function updateEndpointsChart(endpoints) {
            const ctx = document.getElementById('endpoints-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (endpointsChart) {
                endpointsChart.destroy();
            }

            // Check if endpoints data is available
            if (!endpoints || endpoints.length === 0) {
                // Display a message in the chart area
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#666';
                ctx.fillText('No endpoint data available. Enable "Include endpoints" to see endpoint statistics.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            // Prepare data
            const labels = endpoints.map(e => e.endpoint);
            const data = endpoints.map(e => e.count);

            // Create new chart
            endpointsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'API Calls by Endpoint',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // Update daily chart
        function updateDailyChart(dailyData) {
            const ctx = document.getElementById('daily-chart').getContext('2d');

            // Destroy existing chart if it exists
            if (dailyChart) {
                dailyChart.destroy();
            }

            // Prepare data
            const labels = dailyData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString();
            });
            const data = dailyData.map(d => d.count);

            // Create new chart
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily API Calls',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // Update recent calls table
        function updateRecentCalls(calls) {
            const tbody = document.getElementById('recent-calls-body');
            tbody.innerHTML = '';

            calls.forEach(call => {
                const row = document.createElement('tr');

                // Format date
                const date = new Date(call.created_at);
                const formattedDate = date.toLocaleString();

                // Format execution time
                const executionTime = call.execution_time ? `${call.execution_time.toFixed(2)}s` : 'N/A';

                // Create row
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${call.endpoint}</td>
                    <td>${call.query || 'N/A'}</td>
                    <td>${call.status}</td>
                    <td>${executionTime}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // Update details table
        function updateDetailsTable(records) {
            const tbody = document.getElementById('details-body');
            tbody.innerHTML = '';

            if (records.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" style="text-align: center;">No records found</td>';
                tbody.appendChild(row);
                return;
            }

            records.forEach(record => {
                const row = document.createElement('tr');

                // Format date
                const date = new Date(record.created_at);
                const formattedDate = date.toLocaleString();

                // Format execution time
                const executionTime = record.execution_time ? `${record.execution_time.toFixed(2)}s` : 'N/A';

                // Create row
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${record.endpoint}</td>
                    <td>${record.query || 'N/A'}</td>
                    <td>${record.status}</td>
                    <td>${executionTime}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // Update endpoint filter options
        function updateEndpointOptions(endpoints) {
            const select = document.getElementById('endpoint-filter');

            // Keep the first option (All Endpoints)
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);

            // Add endpoint options
            endpoints.forEach(endpoint => {
                const option = document.createElement('option');
                option.value = endpoint.endpoint;
                option.textContent = endpoint.endpoint;
                select.appendChild(option);
            });
        }

        // Update pagination
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // Don't show pagination if there's only one page
            if (totalPages <= 1) {
                return;
            }

            // Previous button
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => loadPage(currentPage - 1));
            pagination.appendChild(prevButton);

            // Page buttons
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('active', i === currentPage);
                pageButton.addEventListener('click', () => loadPage(i));
                pagination.appendChild(pageButton);
            }

            // Next button
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => loadPage(currentPage + 1));
            pagination.appendChild(nextButton);
        }
    </script>
</body>
</html>
